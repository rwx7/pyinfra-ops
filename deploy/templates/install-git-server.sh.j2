#!/bin/bash

set -euo pipefail

if [ "$EUID" -ne 0 ]; then
    echo "Please run as root"
    exit 1
fi

if ! command -v soft &>/dev/null; then
    # Retrieve and import repository key
    sudo mkdir -p /etc/apt/keyrings
    curl -fsSL https://repo.charm.sh/apt/gpg.key | sudo gpg --dearmor -o /etc/apt/keyrings/charm.gpg
    # Add APT repository source
    echo "deb [signed-by=/etc/apt/keyrings/charm.gpg] https://repo.charm.sh/apt/ * *" | sudo tee /etc/apt/sources.list.d/charm.list
    # Install Soft Serve & git
    apt update && apt install soft-serve git
fi

if [ ! -e /etc/systemd/system/soft-serve.service ]; then
    DATA_DIR={{ data_volume }}/soft-serve
    cat <<EOF >>/etc/systemd/system/soft-serve.service
[Unit]
Description=Soft Serve git server üç¶
Documentation=https://github.com/charmbracelet/soft-serve
Requires=network-online.target
After=network-online.target

[Service]
Type=simple
Restart=always
RestartSec=1
ExecStartPre=mkdir -p $DATA_DIR
ExecStart=/usr/bin/soft serve
Environment=SOFT_SERVE_DATA_PATH=$DATA_DIR
Environment=SOFT_SERVE_INITIAL_ADMIN_KEYS='{{ authorized_keys }}'

[Install]
WantedBy=multi-user.target
EOF

    systemctl daemon-reload
    systemctl enable soft-serve.service
    systemctl start soft-serve.service
fi
